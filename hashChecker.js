const express = require('express');
const sqlite3 = require('sqlite3').verbose();

const app = express();
const dbFile = "./HashDB";
const db = new sqlite3.Database(dbFile);

// Middleware to implement rate limiting
const rateLimitMiddleware = (req, res, next) => {
    const ipAddress = req.ip; // Get IP address from request

    // Check if IP address exists in the rate limit store
    if (!rateLimit[ipAddress]) {
        rateLimit[ipAddress] = [];
    }

    // Remove requests older than 10 seconds
    rateLimit[ipAddress] = rateLimit[ipAddress].filter(timestamp => Date.now() - timestamp < 10000);

    // Check if the request count exceeds the limit
    if (rateLimit[ipAddress].length >= 10) {
        res.status(429).json({ error: 'Rate limit exceeded. Please try again in few seconds.' });
    } else {
        rateLimit[ipAddress].push(Date.now()); // Add current timestamp to the rate limit store
        next();
    }
};

// Your rate limit store (in-memory object)
const rateLimit = {};

// Apply rate limiting middleware to the specified route
app.get('/api/check-hash/:hash', rateLimitMiddleware, (req, res) => {
    const targetHash = req.params.hash;

    const query = `SELECT hash, name FROM HashDB WHERE hash = ?`;
    db.get(query, [targetHash], (err, row) => {
        if (err) {
            console.error("Error:", err);
            res.status(500).json({ error: "An error occurred" });
            return;
        }

        if (row) {
            res.json({
                found: true,
                hash: row.hash,
                name: row.name
            });
        } else {
            res.json({ found: false });
        }
    });
});

// New route to retrieve all records
app.get('/api/all-records', (req, res) => {
    const query = `SELECT hash, name FROM HashDB`;
    db.all(query, (err, rows) => {
        if (err) {
            console.error("Error:", err);
            res.status(500).json({ error: "An error occurred" });
            return;
        }

        res.json(rows);
    });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
